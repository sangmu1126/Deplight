# This is the "REAL ENGINE" of our PaaS.
# It triggers on 'git push' or when our UI's "Deploy" button calls the API.
name: Deplight GCP K8s Blue/Green Deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: # This allows our Node.js server to trigger this workflow via API
    inputs:
      version:
        description: 'Version to deploy (e.g., v1.4)'
        required: true
        default: 'v1.4'

# Slack/Server Webhook URLs should be stored in GitHub Secrets
env:
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  DEPLIGHT_WEBHOOK_URL: ${{ secrets.DEPLIGHT_API_URL }}/webhook/github 
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_ZONE: 'asia-northeast3' # Seoul
  GCP_CLUSTER_NAME: 'hackathon-cluster' # K8s Cluster
  
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------------------------------------------
      # 1. NOTIFY: START (Slack + UI)
      # -----------------------------------------------------------------
      - name: Send "Deploy Started" to Slack & UI
        run: |
          # Send "Toss-style" message to Slack
          curl -X POST -H 'Content-type: application/json' --data '{"text":"ğŸš€ (Deplight) ë°°í¬ ì‹œì‘: ${{ github.actor }}ë‹˜ì´ ${{ github.event.inputs.version }} ë°°í¬ë¥¼ ì‹œì‘í–ˆìŠµë‹ˆë‹¤! (ì”¨ì•— ì‹¬ê¸°)"}' $SLACK_WEBHOOK_URL
          
          # Send "Linting" log to our Node.js server -> UI
          curl -X POST -H 'Content-type: application/json' --data '{"id": 1, "log": {"time": "${{ fromJson(toJSON(job.started_at)) }}", "message": "ğŸ§ í™ì„ ê³ ë¥´ê³  ì”¨ì•—ì„ ì‹¬ëŠ” ì¤‘...", "status": "LINTING"}}' $DEPLIGHT_WEBHOOK_URL

      # -----------------------------------------------------------------
      # 2. LINT / TEST (The "Fly" check)
      # -----------------------------------------------------------------
      - name: Lint & Test
        run: |
          # (This is where 'sample-app' tests would run)
          echo "Running Lint & Unit Tests..."
          sleep 5 # Simulate tests
          # (If this step fails, the 'Notify: Failure' job will run)

      - name: Send "Test OK" to Slack & UI
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"âœ… (Deplight) í…ŒìŠ¤íŠ¸ í†µê³¼! (ìƒˆì‹¹ ë‹ì•„ë‚¨)"}' $SLACK_WEBHOOK_URL
          curl -X POST -H 'Content-type: application/json' --data '{"id": 1, "log": {"time": "${{ fromJson(toJSON(job.started_at)) }}", "message": "âœ… ì¢‹ì•„ìš”! ê±´ê°•í•œ ìƒˆì‹¹ì´ ë‹ì•„ë‚¬ì–´ìš”.", "status": "TESTING"}}' $DEPLIGHT_WEBHOOK_URL

      # -----------------------------------------------------------------
      # 3. BUILD & PUSH TO GCP
      # -----------------------------------------------------------------
      - name: Build and Push to GCP Artifact Registry
        run: |
          # (This is a placeholder for real gcloud/docker commands)
          echo "Logging into GCP..."
          echo "Building Docker image..."
          sleep 10
          echo "Pushing image to gcr.io/${{ env.GCP_PROJECT_ID }}/deplight-app:${{ github.sha }}"
          curl -X POST -H 'Content-type: application/json' --data '{"id": 1, "log": {"time": "${{ fromJson(toJSON(job.started_at)) }}", "message": "ğŸ“¦ ì‘¥ì‘¥! ì¤„ê¸°ê°€ ìë¼ê³  ìˆì–´ìš”. (GCPì— í‘¸ì‹œ ì™„ë£Œ)", "status": "BUILDING"}}' $DEPLIGHT_WEBHOOK_URL

      # -----------------------------------------------------------------
      # 4. DEPLOY TO GCP (K8s) - The Blue/Green Magic
      # -----------------------------------------------------------------
      - name: Deploy to K8s (Blue/Green)
        run: |
          echo "Connecting to K8s cluster: ${{ env.GCP_CLUSTER_NAME }}"
          echo "Applying k8s-deployment-green.yml..."
          sleep 15
          echo "Waiting for Green deployment to be healthy..."
          curl -X POST -H 'Content-type: application/json' --data '{"id": 1, "log": {"time": "${{ fromJson(toJSON(job.started_at)) }}", "message": "ğŸš€ ìì´ ë¬´ì„±í•´ì§€ëŠ” ì¤‘... (Green ë°°í¬)", "status": "DEPLOYING"}}' $DEPLIGHT_WEBHOOK_URL
          
          echo "Switching traffic (K8s Service) from Blue to Green..."
          sleep 5
          curl -X POST -H 'Content-type: application/json' --data '{"id": 1, "log": {"time": "${{ fromJson(toJSON(job.started_at)) }}", "message": "ğŸš¦ ë‘ê·¼ë‘ê·¼... ê½ƒì´ í”¼ê¸° ì§ì „ì´ì—ìš”!", "status": "ROUTING"}}' $DEPLIGHT_WEBHOOK_URL

      # -----------------------------------------------------------------
      # 5. NOTIFY: SUCCESS
      # -----------------------------------------------------------------
      - name: Send "Deploy Success" to Slack & UI
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"âœ¨ (Deplight) ë°°í¬ ì„±ê³µ! v${{ github.event.inputs.version }}ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. (ê½ƒ í”¼ìš°ê¸°)"}' $SLACK_WEBHOOK_URL
          curl -X POST -H 'Content-type: application/json' --data '{"id": 1, "log": {"time": "${{ fromJson(toJSON(job.started_at)) }}", "message": "âœ¨ ì™„ë²½í•´ìš”! ì˜ˆìœ ê½ƒì´ í”¼ì—ˆì–´ìš”!", "status": "DONE"}}' $DEPLIGHT_WEBHOOK_URL
          curl -X POST -H 'Content-type: application/json' --data '{"id": 1, "log": {"time": "${{ fromJson(toJSON(job.started_at)) }}", "message": "AI ë¶„ì„: k6 í…ŒìŠ¤íŠ¸ í†µê³¼. ì‘ë‹µì†ë„ 12% í–¥ìƒ.", "status": "AI_INSIGHT"}}' $DEPLIGHT_WEBHOOK_URL
          curl -X POST -H 'Content-type: application/json' --data '{"id": 1, "status": "HEALTHY", "plant": "rose"}' $DEPLIGHT_API_URL/webhook/plant-complete # (ì‹ ê·œ) ì‹ë¬¼ ì™„ì„± API

  # -----------------------------------------------------------------
  # 6. NOTIFY: FAILURE (The "Fly")
  # -----------------------------------------------------------------
  notify-failure:
    runs-on: ubuntu-latest
    if: failure() # Run this job only if any previous step failed
    needs: build-and-deploy # Wait for the main job to fail
    steps:
      - name: Send "Deploy Failure" to Slack & UI
        run: |
          echo "Deployment failed!"
          curl -X POST -H 'Content-type: application/json' --data '{"text":"ğŸª° (Deplight) ë°°í¬ ì‹¤íŒ¨! ë¡¤ë°±ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤."}' $SLACK_WEBHOOK_URL
          curl -X POST -H 'Content-type: application/json' --data '{"id": 1, "log": {"time": "${{ fromJson(toJSON(job.started_at)) }}", "message": "ğŸ˜­ ì•¼ìƒì˜ íŒŒë¦¬ê°€ ë‚˜íƒ€ë‚¬ì–´ìš”! (ë¡¤ë°± ì¤‘)", "status": "FAILED"}}' $DEPLIGHT_WEBHOOK_URL
          curl -X POST -H 'Content-type: application/json' --data '{"id": 1, "log": {"time": "${{ fromJson(toJSON(job.started_at)) }}", "message": "AI ë¶„ì„: ''Test'' ë‹¨ê³„ ì‹¤íŒ¨. (íŒŒë¦¬ ì›ì¸)", "status": "AI_INSIGHT"}}' $DEPLIGHT_WEBHOOK_URL